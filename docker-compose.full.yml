version: '3.8'

# 전체 서비스 통합 구성 - Command/Event Sourcing + Redis + WebSocket 통합
# 포함 서비스: TerminusDB, PostgreSQL, Redis, Kafka, OMS, BFF, Funnel, Worker, Message Relay
# WebSocket 실시간 업데이트 완전 지원
# 실행: docker-compose -f docker-compose.full.yml up -d

# 서비스 실행 순서:
# 1. 데이터베이스 (TerminusDB, PostgreSQL, Redis)
# 2. 메시지 브로커 (Zookeeper, Kafka)
# 3. 핵심 서비스 (OMS, BFF, Funnel) - WebSocket 자동 시작
# 4. 백그라운드 서비스 (Message Relay, Ontology Worker)

services:
  # Core services
  terminusdb:
    extends:
      file: backend/docker-compose.yml
      service: terminusdb
      
  oms:
    extends:
      file: backend/docker-compose.yml
      service: oms
    environment:
      - ENABLE_PULL_REQUESTS=true
      # Dev-stack default: allow direct writes on protected branches (smoke/E2E tests + README flow).
      # Set to true in environments that require proposal workflow on protected branches (main/prod).
      - ONTOLOGY_REQUIRE_PROPOSALS=false
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - terminusdb
      - postgres
      - minio
      - otel-collector
      
  bff:
    extends:
      file: backend/docker-compose.yml
      service: bff
    environment:
      - INPUT_SANITIZER_MAX_LIST_ITEMS=10000
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - oms
      - funnel
      - postgres
      - lakefs
      - otel-collector

  agent:
    extends:
      file: backend/docker-compose.yml
      service: agent
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - bff
      - postgres
      - minio
      - otel-collector
      
  funnel:
    extends:
      file: backend/docker-compose.yml
      service: funnel
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - otel-collector
      
  message-relay:
    extends:
      file: backend/docker-compose.yml
      service: message-relay
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - postgres
      - kafka
      - minio
      - otel-collector
      
  ontology-worker:
    extends:
      file: backend/docker-compose.yml
      service: ontology-worker
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - terminusdb
      - kafka
      - message-relay
      - postgres
      - otel-collector
      
  instance-worker:
    extends:
      file: backend/docker-compose.yml
      service: instance-worker
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - terminusdb
      - kafka
      - message-relay
      - postgres
      - minio
      - otel-collector
      
  projection-worker:
    extends:
      file: backend/docker-compose.yml
      service: projection-worker
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - elasticsearch
      - redis
      - kafka
      - message-relay
      - postgres
      - otel-collector

  search-projection-worker:
    extends:
      file: backend/docker-compose.yml
      service: search-projection-worker
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - elasticsearch
      - kafka
      - otel-collector

  # Foundry-style connector runtime (trigger + sync)
  connector-trigger-service:
    extends:
      file: backend/docker-compose.yml
      service: connector-trigger-service
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - kafka
      - postgres
      - otel-collector

  connector-sync-worker:
    extends:
      file: backend/docker-compose.yml
      service: connector-sync-worker
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - bff
      - kafka
      - postgres
      - otel-collector

  pipeline-worker:
    extends:
      file: backend/docker-compose.yml
      service: pipeline-worker
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - kafka
      - postgres
      - minio
      - lakefs
      - otel-collector

  pipeline-scheduler:
    extends:
      file: backend/docker-compose.yml
      service: pipeline-scheduler
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - kafka
      - postgres
      - lakefs
      - otel-collector

  objectify-worker:
    extends:
      file: backend/docker-compose.yml
      service: objectify-worker
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - kafka
      - postgres
      - lakefs
      - oms
      - otel-collector

  ingest-reconciler-worker:
    extends:
      file: backend/docker-compose.yml
      service: ingest-reconciler-worker
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORT_OTLP=true
      - OTEL_ENABLE_TRACING=true
    depends_on:
      - postgres
      - otel-collector
      
  # Database services
  postgres:
    extends:
      file: docker-compose.databases.yml
      service: postgres
      
  redis:
    extends:
      file: docker-compose.databases.yml
      service: redis
      
  elasticsearch:
    extends:
      file: docker-compose.databases.yml
      service: elasticsearch

  minio:
    extends:
      file: docker-compose.databases.yml
      service: minio

  minio-init:
    extends:
      file: docker-compose.databases.yml
      service: minio-init
    depends_on:
      - minio
      
  # Kafka services
  zookeeper:
    extends:
      file: docker-compose.kafka.yml
      service: zookeeper
      
  kafka:
    extends:
      file: docker-compose.kafka.yml
      service: kafka
      
  kafka-ui:
    extends:
      file: docker-compose.kafka.yml
      service: kafka-ui

  lakefs:
    extends:
      file: docker-compose.databases.yml
      service: lakefs

  lakefs-init:
    extends:
      file: docker-compose.databases.yml
      service: lakefs-init
    depends_on:
      - lakefs
      - minio-init

  jaeger:
    image: jaegertracing/all-in-one:1.53
    container_name: spice_jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686"
    networks:
      - spice_network

  otel-collector:
    image: otel/opentelemetry-collector:0.97.0
    container_name: spice_otel_collector
    command: ["--config=/etc/otelcol/config.yml"]
    volumes:
      - ./otel-collector-config.yml:/etc/otelcol/config.yml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
    depends_on:
      - jaeger
    networks:
      - spice_network

volumes:
  terminusdb_data:
  bff_data:
  postgres-data:
  redis-data:
  elasticsearch-data:
  minio-data:
  zookeeper-data:
  zookeeper-logs:
  kafka-data:

networks:
  spice_network:
    name: ${SPICE_NETWORK_NAME:-spice_network}
    driver: bridge
