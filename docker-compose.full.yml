version: '3.8'

# 전체 서비스 통합 구성 - Command/Event Sourcing + Redis + WebSocket 통합
# 포함 서비스: TerminusDB, PostgreSQL, Redis, Kafka, OMS, BFF, Funnel, Worker, Message Relay
# WebSocket 실시간 업데이트 완전 지원
# 실행: docker-compose -f docker-compose.full.yml up -d

# 서비스 실행 순서:
# 1. 데이터베이스 (TerminusDB, PostgreSQL, Redis)
# 2. 메시지 브로커 (Zookeeper, Kafka)
# 3. 핵심 서비스 (OMS, BFF, Funnel) - WebSocket 자동 시작
# 4. 백그라운드 서비스 (Message Relay, Ontology Worker)

services:
  # Core services
  terminusdb:
    extends:
      file: backend/docker-compose.yml
      service: terminusdb
      
  oms:
    extends:
      file: backend/docker-compose.yml
      service: oms
    depends_on:
      - terminusdb
      - postgres
      - minio
      
  bff:
    extends:
      file: backend/docker-compose.yml
      service: bff
    depends_on:
      - oms
      - funnel
      - postgres
      - lakefs
      
  funnel:
    extends:
      file: backend/docker-compose.yml
      service: funnel
      
  message-relay:
    extends:
      file: backend/docker-compose.yml
      service: message-relay
    depends_on:
      - postgres
      - kafka
      - minio
      
  ontology-worker:
    extends:
      file: backend/docker-compose.yml
      service: ontology-worker
    depends_on:
      - terminusdb
      - kafka
      - message-relay
      - postgres
      
  instance-worker:
    extends:
      file: backend/docker-compose.yml
      service: instance-worker
    depends_on:
      - terminusdb
      - kafka
      - message-relay
      - postgres
      - minio
      
  projection-worker:
    extends:
      file: backend/docker-compose.yml
      service: projection-worker
    depends_on:
      - elasticsearch
      - redis
      - kafka
      - message-relay
      - postgres

  search-projection-worker:
    extends:
      file: backend/docker-compose.yml
      service: search-projection-worker
    depends_on:
      - elasticsearch
      - kafka

  # Foundry-style connector runtime (trigger + sync)
  connector-trigger-service:
    extends:
      file: backend/docker-compose.yml
      service: connector-trigger-service
    depends_on:
      - kafka
      - postgres

  connector-sync-worker:
    extends:
      file: backend/docker-compose.yml
      service: connector-sync-worker
    depends_on:
      - bff
      - kafka
      - postgres

  pipeline-worker:
    extends:
      file: backend/docker-compose.yml
      service: pipeline-worker
    depends_on:
      - kafka
      - postgres
      - minio
      - lakefs

  pipeline-scheduler:
    extends:
      file: backend/docker-compose.yml
      service: pipeline-scheduler
    depends_on:
      - kafka
      - postgres
      - lakefs

  objectify-worker:
    extends:
      file: backend/docker-compose.yml
      service: objectify-worker
    depends_on:
      - kafka
      - postgres
      - lakefs
      - oms
      
  # Database services
  postgres:
    extends:
      file: docker-compose.databases.yml
      service: postgres
      
  redis:
    extends:
      file: docker-compose.databases.yml
      service: redis
      
  elasticsearch:
    extends:
      file: docker-compose.databases.yml
      service: elasticsearch

  minio:
    extends:
      file: docker-compose.databases.yml
      service: minio

  minio-init:
    extends:
      file: docker-compose.databases.yml
      service: minio-init
    depends_on:
      - minio
      
  # Kafka services
  zookeeper:
    extends:
      file: docker-compose.kafka.yml
      service: zookeeper
      
  kafka:
    extends:
      file: docker-compose.kafka.yml
      service: kafka
      
  kafka-ui:
    extends:
      file: docker-compose.kafka.yml
      service: kafka-ui

  lakefs:
    extends:
      file: docker-compose.databases.yml
      service: lakefs

  lakefs-init:
    extends:
      file: docker-compose.databases.yml
      service: lakefs-init
    depends_on:
      - lakefs
      - minio-init

volumes:
  terminusdb_data:
  bff_data:
  postgres-data:
  redis-data:
  elasticsearch-data:
  minio-data:
  zookeeper-data:
  zookeeper-logs:
  kafka-data:

networks:
  spice_network:
    name: ${SPICE_NETWORK_NAME:-spice_network}
    driver: bridge
