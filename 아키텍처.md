# ğŸ—ï¸ SPICE HARVESTER ì•„í‚¤í…ì²˜ (Steady State)

> Updated: 2026-01-08  
> Canonical architecture doc: `docs/ARCHITECTURE.md`  
> Contract (idempotency/ordering/OCC): `docs/IDEMPOTENCY_CONTRACT.md`

## 1) Steady-state data path (write + data plane)

**Write path (event sourcing)**  
OMS/Workers â†’ **S3/MinIO Event Store (SSoT)** â†’ **EventPublisher (S3 tail â†’ Kafka)** â†’ Kafka â†’ Consumers

**Data plane path**  
Raw ingest â†’ **lakeFS** â†’ **pipeline-worker(Spark)** â†’ dataset version â†’ **objectify-worker** â†’ graph instances â†’ ES projection

- **Kafka delivery**: at-least-once (duplicates/replays can happen)
- **Idempotency key**: `event_id` (same `event_id` must create side-effects at most once)
- **Ordering**: per-aggregate `sequence_number` is the truth (`incoming_seq <= current_seq` is ignored)
- **OCC**: update/delete commands must carry `expected_seq` (mismatch â†’ **409 Conflict**, command is not appended)

## 2) System diagram (current)

```mermaid
graph TD
    A[Clients] --> B[BFF 8002]
    B --> C[OMS 8000]
    B --> F[Funnel 8003]
    B --> LFS[lakeFS 48080]
    B --> PG[(Postgres 5433<br/>registries + processed_events + seq allocator)]
    C --> S3[(S3/MinIO Event Store<br/>spice-event-store)]
    S3 --> PUB[EventPublisher<br/>(message_relay)]
    PUB --> K[Kafka 39092]
    K --> IW[Instance Worker]
    K --> OW[Ontology Worker]
    K --> PW[Projection Worker]
    K --> PLW[Pipeline Worker]
    K --> OBJ[Objectify Worker]
    IW --> T[TerminusDB 6363]
    OW --> T
    PW --> ES[Elasticsearch 9200]
    PW --> R[Redis 6379]
    IW --> PG
    OW --> PG
    PW --> PG
    PLW --> LFS
    OBJ --> LFS
```

## 2.1) ì¶”ê°€ ì„œë¹„ìŠ¤/ê¸°ëŠ¥ (í˜„ì¬ êµ¬í˜„)

- **search-projection-worker**: ì„ íƒì  ê²€ìƒ‰ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸(ê¸°ë³¸ off).
- **pipeline-scheduler**: ìŠ¤ì¼€ì¤„ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ íŠ¸ë¦¬ê±°.
- **ingest-reconciler-worker**: ingest/outbox ì •í•©ì„± ë³µêµ¬.
- **connector-trigger-service / connector-sync-worker**: Google Sheets ë³€ê²½ ê°ì§€ â†’ BFF ingest í˜¸ì¶œ.
- **BFF outbox workers**: dataset/objectify outboxë¥¼ in-processë¡œ ì²˜ë¦¬.
- **Access policy**: dataset ë‹¨ìœ„ ì •ì±…ìœ¼ë¡œ instance/query/graph ì‘ë‹µ ë§ˆìŠ¤í‚¹.
- **Audit/Lineage**: Postgres ì €ì¥ + BFF ì¡°íšŒ API ì œê³µ.

## 3) Local ports (docker compose defaults)

ê¸°ë³¸ host í¬íŠ¸ì´ë©° `.env` ë˜ëŠ” docker-compose overrideë¡œ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

| Component | Port |
|---|---:|
| OMS | 8000 |
| BFF | 8002 |
| Funnel | 8003 |
| TerminusDB | 6363 |
| MinIO (S3 API) | 9000 |
| MinIO Console | 9001 |
| Kafka | 39092 |
| Postgres | 5433 |
| Redis | 6379 |
| Elasticsearch | 9200 |
| lakeFS | 48080 |

## 4) Operational entry points

- Runbook: `backend/PRODUCTION_MIGRATION_RUNBOOK.md`
- Verification checklist: `backend/FINAL_VERIFICATION_REPORT.md`
- Test runner: `backend/run_production_tests.sh`
