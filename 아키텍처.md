# ðŸ—ï¸ SPICE HARVESTER ì•„í‚¤í…ì²˜ (Steady State)

> Updated: 2025-12-17  
> Canonical architecture doc: `docs/ARCHITECTURE.md`  
> Contract (idempotency/ordering/OCC): `docs/IDEMPOTENCY_CONTRACT.md`

## 1) Steady-state data path (single source of truth)

OMS/Workers â†’ **S3/MinIO Event Store (SSoT)** â†’ **EventPublisher (S3 tail â†’ Kafka)** â†’ Kafka â†’ Consumers

- **Kafka delivery**: at-least-once (duplicates/replays can happen)
- **Idempotency key**: `event_id` (same `event_id` must create side-effects at most once)
- **Ordering**: per-aggregate `sequence_number` is the truth (`incoming_seq <= current_seq` is ignored)
- **OCC**: update/delete commands must carry `expected_seq` (mismatch â†’ **409 Conflict**, command is not appended)

## 2) System diagram (current)

```mermaid
graph TD
    A[Clients] --> B[BFF 8002]
    B --> C[OMS 8000]
    C --> S3[(S3/MinIO Event Store<br/>spice-event-store)]
    S3 --> PUB[EventPublisher<br/>(message_relay)]
    PUB --> K[Kafka 9092]
    K --> IW[Instance Worker]
    K --> OW[Ontology Worker]
    K --> PW[Projection Worker]
    IW --> T[TerminusDB 6363]
    OW --> T
    PW --> ES[Elasticsearch 9200]
    PW --> R[Redis 6379]
    IW --> PG[(Postgres 5433<br/>processed_events + aggregate_versions + seq allocator)]
    OW --> PG
    PW --> PG
```

## 3) Local ports (docker compose defaults)

| Component | Port |
|---|---:|
| OMS | 8000 |
| BFF | 8002 |
| Funnel | 8003 |
| TerminusDB | 6363 |
| MinIO (S3 API) | 9000 |
| MinIO Console | 9001 |
| Kafka | 9092 |
| Postgres | 5433 |
| Redis | 6379 |
| Elasticsearch | 9200 |

## 4) Operational entry points

- Runbook: `backend/PRODUCTION_MIGRATION_RUNBOOK.md`
- Verification checklist: `backend/FINAL_VERIFICATION_REPORT.md`
- Test runner: `backend/run_production_tests.sh`
