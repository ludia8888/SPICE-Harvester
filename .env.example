# SPICE HARVESTER Environment Variables

# TerminusDB Configuration
TERMINUS_SERVER_URL=http://localhost:6363
TERMINUS_USER=admin
TERMINUS_ACCOUNT=admin
TERMINUS_KEY=admin

# PostgreSQL Configuration
POSTGRES_HOST=localhost
POSTGRES_PORT=5433
POSTGRES_USER=spiceadmin
POSTGRES_PASSWORD=spicepass123
POSTGRES_DB=spicedb

# Redis Configuration
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=spicepass123

# Elasticsearch Configuration
ELASTICSEARCH_HOST=localhost
ELASTICSEARCH_PORT=9200
ELASTICSEARCH_USERNAME=
ELASTICSEARCH_PASSWORD=

# Kafka Configuration
KAFKA_HOST=localhost
KAFKA_PORT=9092

# MinIO Configuration
MINIO_ENDPOINT_URL=http://localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin123
EVENT_STORE_BUCKET=spice-event-store
# Optional blob bucket (InstanceWorker stores full payload snapshots here)
INSTANCE_BUCKET=instance-events

# Service URLs
OMS_BASE_URL=http://localhost:8000
BFF_BASE_URL=http://localhost:8002
FUNNEL_BASE_URL=http://localhost:8003

# Context7 MCP Configuration
CONTEXT7_API_KEY=your_context7_api_key_here
CONTEXT7_WORKSPACE=your_workspace_name

# MCP Server Configuration
MCP_CONFIG_PATH=./mcp-config.json
MCP_LOG_LEVEL=info
MCP_TIMEOUT=30000

# Application Settings
LOG_LEVEL=INFO
USE_HTTPS=false
VERIFY_SSL=false

# Debug endpoints (opt-in; never enable in production)
ENABLE_DEBUG_ENDPOINTS=false

# MVCC Settings
DEFAULT_ISOLATION_LEVEL=REPEATABLE_READ
MAX_RETRY_ATTEMPTS=5
DEADLOCK_RETRY_DELAY=0.1

# Event Sourcing Settings
# Event Publisher (S3/MinIO tail -> Kafka)
EVENT_PUBLISHER_BATCH_SIZE=200
EVENT_PUBLISHER_POLL_INTERVAL=3
EVENT_PUBLISHER_CHECKPOINT_KEY=checkpoints/event_publisher.json
EVENT_PUBLISHER_DEDUP_MAX_EVENTS=10000
# Legacy aliases (still supported)
# MESSAGE_RELAY_BATCH_SIZE=200
# MESSAGE_RELAY_POLL_INTERVAL=3

# Event Store write-side sequencing (OCC)
EVENT_STORE_SEQUENCE_ALLOCATOR_MODE=postgres
EVENT_STORE_SEQUENCE_SCHEMA=spice_event_registry
EVENT_STORE_SEQUENCE_HANDLER_PREFIX=write_side
EVENT_STORE_IDEMPOTENCY_MISMATCH_MODE=error  # error|warn

# Durable processed-event registry (worker/projection idempotency)
ENABLE_PROCESSED_EVENT_REGISTRY=true
PROCESSED_EVENT_LEASE_TIMEOUT_SECONDS=900
PROCESSED_EVENT_HEARTBEAT_INTERVAL_SECONDS=30

# Worker Settings
ONTOLOGY_WORKER_GROUP=ontology-worker-group
INSTANCE_WORKER_GROUP=instance-worker-group
PROJECTION_WORKER_GROUP=projection-worker-group
ONTOLOGY_WORKER_MAX_RETRY_ATTEMPTS=5
INSTANCE_WORKER_MAX_RETRY_ATTEMPTS=5
PROJECTION_WORKER_MAX_RETRIES=5

# Dangerous admin operations (default OFF)
# Rollback is effectively a "force-push/reset" on TerminusDB branches.
# Prefer "Versioning + Recompute" in production; enable rollback only in non-prod with explicit approval.
ENABLE_OMS_ROLLBACK=false

# Admin API guard (BFF `/api/v1/admin/*`)
# Required header:
#   X-Admin-Token: <BFF_ADMIN_TOKEN>
# Optional:
#   X-Admin-Actor: <name/email>
BFF_ADMIN_TOKEN=

# Unified admin token (recommended; used by both BFF and OMS)
ADMIN_TOKEN=change_me

# Auth enforcement (fail-closed defaults)
BFF_REQUIRE_AUTH=true
OMS_REQUIRE_AUTH=true
BFF_AUTH_EXEMPT_PATHS=/api/v1/health,/api/v1/
OMS_AUTH_EXEMPT_PATHS=/health,/
ALLOW_INSECURE_BFF_AUTH_DISABLE=false
ALLOW_INSECURE_OMS_AUTH_DISABLE=false
ALLOW_INSECURE_AUTH_DISABLE=false

# OMS client auth (when BFF calls OMS)
OMS_CLIENT_TOKEN=

# Command status retention (0 = no expiry)
COMMAND_STATUS_TTL_SECONDS=0

# Event store TLS enforcement
EVENT_STORE_REQUIRE_TLS=false
EVENT_STORE_SSL_VERIFY=true

# Rate limiting local fallback
RATE_LIMIT_LOCAL_MAX_ENTRIES=10000
