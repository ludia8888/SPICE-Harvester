name: CI

on:
  push:
  pull_request:

jobs:
  backend-unit:
    name: Backend Unit
    uses: ./.github/workflows/backend-coverage.yml
    with:
      python-version: "3.11"
      make-target: backend-unit

  backend-coverage:
    name: Backend Coverage
    uses: ./.github/workflows/backend-coverage.yml
    with:
      python-version: "3.11"
      make-target: backend-coverage
      upload-coverage: true
      coverage-file: coverage.xml
      codecov-flags: backend
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  backend-methods:
    name: Backend Method Index
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify BACKEND_METHODS.md
        run: python scripts/generate_backend_methods.py --check

  frontend-check:
    name: Frontend Lint + Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json

      - name: Install
        working-directory: frontend
        run: npm ci

      - name: Lint
        working-directory: frontend
        run: npm run lint

      - name: Build
        working-directory: frontend
        run: npm run build

  frontend-coverage:
    name: Frontend Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json

      - name: Install
        working-directory: frontend
        run: npm ci

      - name: Test + Coverage
        working-directory: frontend
        run: npm run test

  backend-stack-tests:
    name: Backend Stack Tests
    uses: ./.github/workflows/backend-stack-tests.yml
    with:
      python-version: "3.11"
      script-args: "--full"
      timeout-seconds: 300
